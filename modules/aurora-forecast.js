/**
 * aurora-forecast.js
 * "–≠–∫—Å–ø–µ—Ä—Ç-–∞—Å—Ç—Ä–æ—Ñ–∏–∑–∏–∫": –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞–±–∑–∞—Ü –æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —Å–µ–≤–µ—Ä–Ω–æ–≥–æ —Å–∏—è–Ω–∏—è.
 */
import { GoogleGenerativeAI } from "@google/generative-ai";

const HEADING = "üåå –ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –¥–æ–∑–æ—Ä";

const KP_THRESHOLD = 5;

const fallbackAuroraText = (kp) =>
  `${HEADING}\n\n–ì–µ–æ–º–∞–≥–Ω–∏—Ç–Ω—ã–π —Ñ–æ–Ω –ø–æ–≤—ã—à–µ–Ω: –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π Kp-–∏–Ω–¥–µ–∫—Å –æ–∫–æ–ª–æ ${kp}. –ï—Å—Ç—å —à–∞–Ω—Å —É–≤–∏–¥–µ—Ç—å —Å–µ–≤–µ—Ä–Ω–æ–µ —Å–∏—è–Ω–∏–µ ‚Äî –≤—ã–±–∏—Ä–∞–π—Ç–µ —Ç—ë–º–Ω—ã–µ –ø–ª–æ—â–∞–¥–∫–∏ —Å –≤–∏–¥–æ–º –Ω–∞ —Å–µ–≤–µ—Ä –∏ —Å–ª–µ–¥–∏—Ç–µ –∑–∞ —Å–≤–æ–¥–∫–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.`;

export async function generateAuroraSection(spaceData, geminiConfig) {
  if (!spaceData || spaceData.kp_index == null) {
    return null;
  }

  const kp = Number(spaceData.kp_index);
  if (!Number.isFinite(kp) || kp < KP_THRESHOLD) {
    return null;
  }

  const prompt = `
–¢–≤–æ—è —Ä–æ–ª—å: –ê—Å—Ç—Ä–æ—Ñ–∏–∑–∏–∫, –≤–µ–¥—É—â–∏–π —Ä—É–±—Ä–∏–∫—É "–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –¥–æ–∑–æ—Ä".
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ù–∞ –æ—Å–Ω–æ–≤–µ Kp-–∏–Ω–¥–µ–∫—Å–∞, –Ω–∞–ø–∏—Å–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–π (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –∏ –ø–æ–Ω—è—Ç–Ω—ã–π
–ø—Ä–æ–≥–Ω–æ–∑ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —É–≤–∏–¥–µ—Ç—å —Å–µ–≤–µ—Ä–Ω–æ–µ —Å–∏—è–Ω–∏–µ –Ω–∞–¥ –õ–∞—Ç–≤–∏–µ–π. –û–±—ä—è—Å–Ω–∏, —á—Ç–æ –∑–Ω–∞—á–∏—Ç
—Ç–µ–∫—É—â–∏–π Kp-–∏–Ω–¥–µ–∫—Å. Kp-–∏–Ω–¥–µ–∫—Å 5 –∏ –≤—ã—à–µ - —Ö–æ—Ä–æ—à–∏–π —à–∞–Ω—Å, –Ω–∏–∂–µ 4 - –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ.
–¢–æ–Ω ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, –∫–∞–∫ —É –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞ –Ω–æ—á–Ω—ã—Ö –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π.

–î–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:
Kp-–∏–Ω–¥–µ–∫—Å: ${spaceData.kp_index}

–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ (–¥–ª—è Kp=2): "–û—Ö–æ—Ç–Ω–∏–∫–∞–º –∑–∞ —Å–µ–≤–µ—Ä–Ω—ã–º —Å–∏—è–Ω–∏–µ–º —Å–µ–≥–æ–¥–Ω—è –ø—Ä–∏–¥—ë—Ç—Å—è
–Ω–∞–±—Ä–∞—Ç—å—Å—è —Ç–µ—Ä–ø–µ–Ω–∏—è. –ì–µ–æ–º–∞–≥–Ω–∏—Ç–Ω–æ–µ –ø–æ–ª–µ –ó–µ–º–ª–∏ —Å–ø–æ–∫–æ–π–Ω–æ, –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π Kp-–∏–Ω–¥–µ–∫—Å
—Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å–µ–≥–æ ${spaceData.kp_index}, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –ø–æ—è–≤–ª–µ–Ω–∏–µ –ê–≤—Ä–æ—Ä—ã –Ω–∞–¥ –õ–∞—Ç–≤–∏–µ–π
–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω—ã–º."
–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ (–¥–ª—è Kp=5): "–í–Ω–∏–º–∞–Ω–∏–µ, –ª—é–±–∏—Ç–µ–ª–∏ –Ω–æ—á–Ω–æ–≥–æ –Ω–µ–±–∞! –ì–µ–æ–º–∞–≥–Ω–∏—Ç–Ω–æ–µ –ø–æ–ª–µ
–≤–æ–∑–º—É—â–µ–Ω–æ, –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π Kp-–∏–Ω–¥–µ–∫—Å –¥–æ—Å—Ç–∏–≥ –æ—Ç–º–µ—Ç–∫–∏ ${spaceData.kp_index}! –≠—Ç–æ
–æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–µ–º —Ç–µ–º–Ω–æ—Ç—ã –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —à–∞–Ω—Å —É–≤–∏–¥–µ—Ç—å —Å–µ–≤–µ—Ä–Ω–æ–µ —Å–∏—è–Ω–∏–µ
–¥–∞–∂–µ –≤ –Ω–∞—à–∏—Ö —à–∏—Ä–æ—Ç–∞—Ö."
`;

  try {
    const model = geminiConfig.genAI.getGenerativeModel({ model: geminiConfig.modelName });
    const result = await model.generateContent(prompt);
    return `${HEADING}\n\n${result.response.text().trim()}`;
  } catch (error) {
    console.warn(`    -> –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–∞–∑–¥–µ–ª–∞ –æ–± –∞–≤—Ä–æ—Ä–µ: ${error.message}`);
    return fallbackAuroraText(kp.toFixed(1));
  }
}
